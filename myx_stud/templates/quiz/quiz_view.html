{% extends 'base.html' %}
{% block title %}Quiz{% endblock %}

{% block content %}
  {% if question %}

    {# ===================== RATING-PHASE (Full-Screen) ===================== #}
    {% if ask_rating %}
      <div class="container py-5">
        <div class="row justify-content-center">
          <div class="col-md-8 text-center">
            <h4 class="mb-4">Wie gut konnte ich Dir helfen?</h4>

            <form method="post" id="rating-form" class="d-inline-block">
              {% csrf_token %}
              <!-- sorgt dafÃ¼r, dass der View im 'next'-Branch ist -->
              <input type="hidden" name="next" value="1">
              <input type="hidden" name="rating" id="rating-input-auto" value="">
              <div id="star-rating" class="fs-1 text-warning" style="cursor: pointer; user-select:none;">
                <span class="star" data-value="1">â˜†</span>
                <span class="star" data-value="2">â˜†</span>
                <span class="star" data-value="3">â˜†</span>
                <span class="star" data-value="4">â˜†</span>
                <span class="star" data-value="5">â˜†</span>
              </div>
              <div id="rating-hint" class="text-muted mt-3">Klicke auf einen Stern, dann geht es weiter â€¦</div>
              <!-- optional Mini-Spinner wÃ¤hrend Auto-Submit -->
              <div id="rating-loading" class="mt-3 d-none">
                <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                <span class="ms-2">Weiter â€¦</span>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% else %}

    {# ===================== NORMALER QUIZ-SCHIRM ===================== #}

    <div class="container">
          <!-- Aufgabenkasten -->
          <p><b>Aufgabe {{ index }}</b> von {{ total }}</p>

          {% if question.image %}
            <img src="{{ question.image.url }}"
              alt="Quiz Image"
              class="img-fluid rounded shadow-lg mx-auto d-block mb-3"
              style="max-width: 300px; max-height: 300px; object-fit: contain;">
          {% endif %}

          {% if question.text %}
            <p>{{ question.text|default_if_none:""|safe }}</p>
          {% endif %}

          <p>{{ question.question|default_if_none:""|safe  }}</p>

          <!-- Eingabefeld  -->
          <form method="post">
            <textarea name="answer" class="form-control mb-2" rows="5" required>{{ user_answer }}</textarea>
            {% csrf_token %}
            <button type="submit" id="submit-btn" class="btn btn-primary m-1">Absenden</button>
          </form>


          <!-- Feedback -->
          {% if feedback %}
            {% if feedback.is_correct is not None %}
              {% if feedback.is_correct %}
                <div class="alert alert-success">Richtig! ðŸŽ‰</div>
              {% else %}
                <div class="alert alert-info">{{ feedback.feedback_ai }}</div>
              {% endif %}
            {% else %}
              <div class="alert alert-info">{{ feedback.feedback_ai|default:"Sorry, habe gerade keine Zeit, dir zu helfen." }}</div>
            {% endif %}
          {% endif %}


          <form method="post" class="mt-3">
              {% csrf_token %}
              <button type="submit" name="next" id="next-btn" class="btn btn-secondary">NÃ¤chste Frage</button>
          </form>


      </div>
    </div>
    {% endif %}

  {% else %}
    <div class="alert alert-info">ðŸŽ‰ Das Quiz ist beendet!</div>
    <a href="{% url 'quiz/quiz_start' %}" class="btn btn-primary">Nochmal neu starten</a>
  {% endif %}
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Elemente existieren nur in der Rating-Phase:
  const stars = document.querySelectorAll('#star-rating .star');
  const ratingInput = document.getElementById('rating-input-auto'); // hidden input in Rating-Phase
  const form = document.getElementById('rating-form');
  const loading = document.getElementById('rating-loading');

  function highlight(val) {
    stars.forEach(s => {
      const v = parseInt(s.getAttribute('data-value'));
      s.textContent = v <= val ? 'â˜…' : 'â˜†';
    });
  }

  if (stars.length && ratingInput && form) {
    let submitted = false;

    stars.forEach(star => {
      star.addEventListener('mouseenter', function () {
        highlight(parseInt(this.getAttribute('data-value')));
      });
      star.addEventListener('mouseleave', function () {
        highlight(0);
      });
      star.addEventListener('click', function () {
        if (submitted) return;
        const val = parseInt(this.getAttribute('data-value'));
        ratingInput.value = val;

        // UI sperren & Spinner zeigen
        submitted = true;
        stars.forEach(s => s.style.pointerEvents = 'none');
        if (loading) loading.classList.remove('d-none');

        // Auto-Submit â†’ geht in den 'next'-Branch deiner View
        form.submit();
      });
    });

    // initial
    highlight(0);
  }
});
</script>
{% endblock %}
