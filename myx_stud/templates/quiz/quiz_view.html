{% extends 'base.html' %}
{% block title %}Quiz{% endblock %}

{% block content %}
  {% if question %}
    <h4>Question {{ index }} of {{ total }}</h4>

    {% if question.image %}
      <img src="{{ question.image.url }}"
        alt="Quiz Image"
        class="img-fluid rounded shadow-lg mx-auto d-block mb-3"
        style="max-width: 300px; max-height: 300px; object-fit: contain;">
    {% endif %}

    {% if "default" not in question.text and "Default" not in question.text %}
      <p><strong>{{ question.text }}</strong></p>
    {% endif %}

    <p>{{ question.question }}</p>

    {% if feedback %}
      {% if feedback.is_correct is not None %}
        {% if feedback.is_correct %}
          <div class="alert alert-success">Correct! 🎉</div>
        {% else %}
          <div class="alert alert-danger">
            Incorrect. The correct answer is: <strong>{{ feedback.correct_answer }}</strong><br>
            {{ feedback.feedback_ai }}
          </div>
        {% endif %}
      {% else %}
        <div class="alert alert-info">{{ feedback.feedback_ai|default:"No feedback available at the moment." }}</div>
      {% endif %}

    <!-- ⭐ Clickable Star Rating -->
      <div id="rating-section" class="mt-3">
        <strong>Wie hilfreich ist das Feedback? </strong>
        <div id="star-rating" class="fs-3 text-warning" style="cursor: pointer;">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
        <p>Verbessere deine Antwort!</p>
      </div>

    {% endif %}

    <!-- Submit Improved Answer -->
    <form method="post">
      {% csrf_token %}
      <textarea name="answer" class="form-control mb-2" rows="5" required>{{ user_answer }}</textarea>
      <button type="submit" class="btn btn-primary" id="submit-btn" {% if feedback %}disabled{% endif %}>Absenden</button>
    </form>

    <!-- Next Question -->
    {% if feedback %}
      <form method="post" class="mt-3">
        {% csrf_token %}
        <button type="submit" name="next" class="btn btn-secondary" id="next-btn" disabled>Nächste Frage</button>
      </form>
    {% endif %}
  {% else %}
    <div class="alert alert-info">🎉 Das Quiz ist beendet!</div>
    <a href="{% url 'quiz/quiz_start' %}" class="btn btn-primary">Nochmal neu starten</a>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const stars = document.querySelectorAll('#star-rating .star');
  const nextBtn = document.getElementById('next-btn');
  const submitBtn = document.getElementById('submit-btn');

  let ratingValue = 0;

  stars.forEach(star => {
    star.addEventListener('mouseenter', function () {
      const val = parseInt(this.getAttribute('data-value'));
      highlightStars(val);
    });

    star.addEventListener('mouseleave', function () {
      highlightStars(ratingValue);
    });

    star.addEventListener('click', function () {
      ratingValue = parseInt(this.getAttribute('data-value'));
      highlightStars(ratingValue);
      if (nextBtn) nextBtn.disabled = false;
      if (submitBtn) submitBtn.disabled = false;
    });
  });

  function highlightStars(val) {
    stars.forEach(star => {
      const starVal = parseInt(star.getAttribute('data-value'));
      star.textContent = starVal <= val ? '★' : '☆';
    });
  }

  // Initialize all as empty
  highlightStars(0);
});
</script>

{% endblock %}
