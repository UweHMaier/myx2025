{% extends 'base.html' %}
{% block title %}Quiz{% endblock %}

{% block content %}
  {% if question %}

    <div class="container">
      <div class="row">
        <div class="col-sm">
          <!-- Linke Spalte mit Bild, Text und Aufgabe -->
          <p>Aufgabe {{ index }} von {{ total }}</p>

          {% if question.image %}
            <img src="{{ question.image.url }}"
              alt="Quiz Image"
              class="img-fluid rounded shadow-lg mx-auto d-block mb-3"
              style="max-width: 300px; max-height: 300px; object-fit: contain;">
          {% endif %}

          {% if question.text %}
            <p>{{ question.text }}</p>
          {% endif %}

              
          {% if feedback %}
            <!-- Nächste Frage -->
            <form method="post" class="mt-3">
              {% csrf_token %}
              <input type="hidden" name="rating" id="rating-input-next" value="">
              <button type="submit" name="next" id="next-btn" class="btn btn-secondary" disabled>Nächste Frage</button>
            </form>
          {% endif %}

        </div>
        <div class="col-sm">
          <!-- Rechte Spalte mit Eingabe, Feedbackrating, Feedback -->
          
          <p>{{ question.question }}</p>

          <!-- Eingabefeld und Absenden -->
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="rating" id="rating-input-submit" value="">
            <textarea name="answer" class="form-control mb-2" rows="5" required>{{ user_answer }}</textarea>
            <button type="submit" id="submit-btn" class="btn btn-primary" {% if feedback %}disabled{% endif %}>Absenden</button>
          </form>


          <!-- Feedbackfeld -->
          {% if feedback %}
            {% if feedback.is_correct is not None %}
              {% if feedback.is_correct %}
                <div class="alert alert-success">Richtig! 🎉</div>
              {% else %}
                <div class="alert alert-danger">
                  Incorrect. The correct answer is: <strong>{{ feedback.correct_answer }}</strong><br>
                  {{ feedback.feedback_ai }}
                </div>
              {% endif %}
            {% else %}
              <div class="alert alert-info">{{ feedback.feedback_ai|default:"No feedback available at the moment." }}</div>
            {% endif %}

          <!-- ⭐ Clickable Star Rating -->
            <div id="rating-section" class="mt-3">
              <strong>Wie hilfreich ist das Feedback? </strong>
              <div id="star-rating" class="fs-3 text-warning" style="cursor: pointer;">
                <span class="star" data-value="1">★</span>
                <span class="star" data-value="2">★</span>
                <span class="star" data-value="3">★</span>
                <span class="star" data-value="4">★</span>
                <span class="star" data-value="5">★</span>
              </div>
              <p>Verbessere deine Antwort!</p>
            </div>

          {% endif %}


        </div>
      </div>
    </div>


  {% else %}
    <div class="alert alert-info">🎉 Das Quiz ist beendet!</div>
    <a href="{% url 'quiz/quiz_start' %}" class="btn btn-primary">Nochmal neu starten</a>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const stars = document.querySelectorAll('#star-rating .star');
  const nextBtn = document.getElementById('next-btn');
  const submitBtn = document.getElementById('submit-btn');

  // die beiden Hidden-Felder (können je nach Zustand existieren oder nicht)
  const ratingInputSubmit = document.getElementById('rating-input-submit');
  const ratingInputNext = document.getElementById('rating-input-next');

  let ratingValue = 0;

  function syncHiddenInputs() {
    if (ratingInputSubmit) ratingInputSubmit.value = ratingValue || "";
    if (ratingInputNext) ratingInputNext.value = ratingValue || "";
  }

  function highlightStars(val) {
    stars.forEach(star => {
      const starVal = parseInt(star.getAttribute('data-value'));
      star.textContent = starVal <= val ? '★' : '☆';
    });
  }

  stars.forEach(star => {
    star.addEventListener('mouseenter', function () {
      const val = parseInt(this.getAttribute('data-value'));
      highlightStars(val);
    });

    star.addEventListener('mouseleave', function () {
      highlightStars(ratingValue);
    });

    star.addEventListener('click', function () {
      ratingValue = parseInt(this.getAttribute('data-value'));
      highlightStars(ratingValue);
      syncHiddenInputs();
      if (nextBtn) nextBtn.disabled = false;
      if (submitBtn) submitBtn.disabled = false;
    });
  });

  // Initialize all as empty
  highlightStars(0);
  syncHiddenInputs();
});
</script>


{% endblock %}
